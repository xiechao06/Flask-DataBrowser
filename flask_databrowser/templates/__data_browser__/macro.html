{% macro render_form_fields(form, focus_set=False) %}
    {{ form.hidden_tag() if form.hidden_tag is defined }}

    {% for f in form if f.type != 'HiddenField' and f.type != 'CSRFTokenField' %}
        <div class="control-group{{ ' error' if f.errors }}">
            <div class="control-label">
                <strong>{{ f.label.text }}</strong>
                {% if f.type != 'ReadOnlyField' and h.is_required_form_field(f) %}
                    <strong style="color: red">&#42;</strong>
                {% else %}
                    &nbsp;
                {% endif %}
            </div>
            {% if h.is_batch_edit() %}
                <script type="text/javascript">
                    $(function () {
                        $("[name=hold_value]").click(function () {
                            if (this.checked) {
                                $(this).parent("div").children("select").select2("disable");
                                $(this).parent("div").children().not($(this)).attr("disabled", true);
                            } else {
                                $(this).parent("div").children("select").select2("enable").attr("disabled", false);
                                $(this).parent("div").children().not($(this)).attr("disabled", false);
                            }
                        });
                    })
                </script>
            {% endif %}
            <div class="controls">
                <div>
                    {% if h.is_batch_edit() %}
                        {% if h.is_disabled_form_field(f) %}
                            {{ f(disabled=True, value=_("唯一值，不能批量修改"))|safe }}
                        {% elif not focus_set %}
                            {{ f(autofocus='autofocus', disabled=True)|safe }}
                            <input type="checkbox" name="hold_value" id=""
                                   checked="checked">保持原值
                            {% set focus_set = True %}
                        {% else %}
                            {{ f(disabled=True)|safe }}
                            <input type="checkbox" name="hold_value" id=""
                                   checked="checked">保持原值
                        {% endif %}
                    {% else %}
                        {% if not focus_set %}
                            {{ f(autofocus='autofocus')|safe }}
                            {% set focus_set = True %}
                        {% else %}
                            {{ f()|safe }}
                        {% endif %}
                    {% endif %}
                </div>
                {% if f.description %}
                    <p class="help-block">{{ f.description }}</p>
                {% endif %}
                {% if f.errors %}
                    <ul>
                        {% for e in f.errors if e is string %}
                            <li>{{ e }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>
    {% endfor %}
{% endmacro %}

{% macro form_tag() %}
    <form action="" method="POST" class="form-horizontal"{% if form.has_file_field %} enctype="multipart/form-data"{% endif %}>
        <fieldset>
            {{ caller() }}
        </fieldset>
    </form>
{% endmacro %}

{% macro create() %}
    <input name="_add_another" type="submit" class="btn btn-large" value="{{ _gettext('Save and Add') }}" />
{% endmacro %}

{% macro render_form_buttons(cancel_url, extra=None) %}
    <div class="control-group">
        <div class="controls">
            <input type="submit" class="btn btn-primary btn-large" value="{{ _gettext('提交') }}" />
            {% if extra == "create" %}
                {{ create() }}
            {% endif %}
            {% if cancel_url %}
                <a href="{{ cancel_url }}" class="btn btn-large">{{ _gettext('返回') }}</a>
            {% endif %}
        </div>
    </div>
{% endmacro %}

{% macro render_form(form, cancel_url, extra=None) -%}
    {% call form_tag() %}
        {{ render_form_fields(form) }}
        {{ render_form_buttons(cancel_url, extra) }}
    {% endcall %}
{% endmacro %}

